<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zero-UI Payment Proto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* VIEW CONTAINERS */
        .view { display: none; width: 100%; max-width: 400px; padding: 20px; box-sizing: border-box; }
        .view.active { display: flex; flex-direction: column; height: 100vh; }
        
        /* CARD STYLING */
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; transition: 0.3s; }
        
        /* HEADERS & TEXT */
        h1 { margin: 0 0 10px 0; color: #333; font-size: 24px; }
        p { color: #666; margin: 0 0 20px 0; }
        .amount { font-size: 48px; font-weight: 800; color: #2d3436; margin: 20px 0; }
        .store-id { font-family: monospace; font-size: 32px; letter-spacing: 5px; color: #0984e3; background: #dfe6e9; padding: 10px; border-radius: 10px; margin: 10px 0; display: block;}
        
        /* BUTTONS */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #000; color: white; }
        .btn-success { background: #00b894; color: white; }
        .btn-danger { background: #d63031; color: white; }
        .btn-ghost { background: transparent; color: #0984e3; margin-top: 20px; }

        /* INPUTS */
        input[type="number"] { width: 100%; padding: 15px; font-size: 24px; border: 2px solid #ddd; border-radius: 10px; text-align: center; margin-bottom: 15px; box-sizing: border-box; }

        /* MODAL (Payment Popup) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; }
        .modal { background: white; width: 100%; max-width: 400px; border-radius: 20px 20px 0 0; padding: 30px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* LOADER */
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0984e3; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* LOGS */
        #console { font-family: monospace; font-size: 12px; color: #aaa; margin-top: auto; text-align: left; height: 100px; overflow-y: auto; width: 100%; border-top: 1px solid #eee; padding-top: 10px;}
    </style>
</head>
<body>

    <div id="view-role" class="view active" style="justify-content: center;">
        <div class="card">
            <h1>Select Your Role</h1>
            <p>To test the simulation, open this link on two different devices.</p>
            <button class="btn btn-primary" onclick="selectRole('merchant')">üè™ I am the Merchant (POS)</button>
            <button class="btn btn-success" style="background:#0984e3" onclick="selectRole('user')">üì± I am the Customer</button>
        </div>
    </div>

    <div id="view-merchant" class="view">
        <div class="card">
            <p>Merchant POS</p>
            <small>Pairing Code:</small>
            <div class="store-id" id="merchant-code">...</div>
            <div id="connection-status" style="color:orange; font-size:12px;">Connecting to Network...</div>
        </div>

        <div class="card">
            <p>Enter Bill Amount</p>
            <input type="number" id="bill-amount" placeholder="0.00" value="99999">
            <button id="charge-btn" class="btn btn-primary" onclick="sendChargeRequest()" disabled>‚ö° Charge User</button>
        </div>
        <div id="console"></div>
    </div>

    <div id="view-user" class="view">
        <div class="card" id="pair-card">
            <h1>Connect to Store</h1>
            <p>Enter the 4-digit code shown on the Merchant Screen.</p>
            <input type="number" id="input-store-code" placeholder="XXXX">
            <button class="btn btn-primary" onclick="connectToStore()">Connect</button>
        </div>

        <div class="card" id="listening-card" style="display:none;">
            <div class="spinner"></div>
            <h2>Connected</h2>
            <p>Phone is locked in pocket...</p>
            <p style="font-size:12px; color:#aaa;">Waiting for payment request...</p>
        </div>
        
        <div id="pay-modal" class="modal-overlay">
            <div class="modal">
                <h2 style="text-align:center">Confirm Payment</h2>
                <div class="amount" style="text-align:center" id="modal-amount">$0</div>
                <div style="text-align:center; color:#666; margin-bottom:20px;">Store ID: <span id="modal-store"></span></div>
                
                <div style="background:#eee; padding:15px; border-radius:10px; margin-bottom:20px; font-size:14px;">
                    üîí <strong>Secure Handshake</strong><br>
                    Distance Verified: 2.0 meters<br>
                    Identity: Verified
                </div>

                <button class="btn btn-success" onclick="approvePayment()">Tap to Pay</button>
                <button class="btn btn-danger" style="background:white; color:#d63031; border:1px solid #ddd;" onclick="closeModal()">Decline</button>
            </div>
        </div>
        <div id="console"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Using public Eclipse Mosquitto broker (Free, supports WebSockets)
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8084; // SSL Port
        const MQTT_PATH = "/mqtt";
        
        let client;
        let myRole = "";
        let storeCode = "";
        let topicBase = "zeroui/demo/"; 

        // --- UI LOGIC ---

        function selectRole(role) {
            myRole = role;
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + role).classList.add('active');

            if (role === 'merchant') {
                initMerchant();
            }
        }

        function log(msg) {
            console.log(msg);
            const logs = document.querySelectorAll('#console');
            logs.forEach(l => l.innerHTML += `> ${msg}<br>`);
        }

        // --- MQTT CONNECTION LOGIC ---

        function setupMqtt(onConnectCallback) {
            // Create unique client ID
            const clientId = "client_" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_BROKER, Number(MQTT_PORT), MQTT_PATH, clientId);

            client.onConnectionLost = (responseObject) => {
                log("Connection Lost: " + responseObject.errorMessage);
            };

            client.onMessageArrived = (message) => {
                handleMessage(message.destinationName, message.payloadString);
            };

            const options = {
                timeout: 3,
                useSSL: true,
                onSuccess: onConnectCallback,
                onFailure: (err) => { log("Connect Failed: " + err.errorMessage); }
            };

            client.connect(options);
        }

        // --- MERCHANT LOGIC ---

        function initMerchant() {
            // 1. Generate Random Store Code
            storeCode = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('merchant-code').innerText = storeCode;
            
            // 2. Connect to MQTT
            setupMqtt(() => {
                document.getElementById('connection-status').innerText = "üü¢ Online - Ready";
                document.getElementById('connection-status').style.color = "green";
                document.getElementById('charge-btn').disabled = false;
                
                // Subscribe to my own store's "Response" channel
                client.subscribe(topicBase + storeCode + "/response");
                log(`Listening on channel: ${storeCode}`);
            });
        }

        function sendChargeRequest() {
            const amount = document.getElementById('bill-amount').value;
            if(!amount) return;

            const payload = JSON.stringify({
                type: "PAY_REQUEST",
                amount: amount,
                storeName: "Demo Store #" + storeCode
            });

            // Publish to Store's Channel
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topicBase + storeCode + "/request";
            client.send(message);
            
            log(`Sent Request: $${amount}`);
            document.getElementById('charge-btn').innerText = "‚è≥ Waiting for User...";
            document.getElementById('charge-btn').disabled = true;
        }

        // --- CUSTOMER LOGIC ---

        function connectToStore() {
            const codeInput = document.getElementById('input-store-code').value;
            if (codeInput.length !== 4) return alert("Please enter 4 digit code");
            
            storeCode = codeInput;
            document.getElementById('pair-card').style.display = 'none';
            document.getElementById('listening-card').style.display = 'block';

            setupMqtt(() => {
                // Subscribe to the Store's "Request" channel
                client.subscribe(topicBase + storeCode + "/request");
                log(`Connected to Store ${storeCode}. Listening...`);
            });
        }

        function approvePayment() {
            const payload = JSON.stringify({
                type: "PAY_SUCCESS",
                user: "John Doe",
                status: "APPROVED"
            });

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topicBase + storeCode + "/response";
            client.send(message);

            closeModal();
            alert("Payment Sent! Check Merchant Screen.");
        }

        // --- MESSAGE HANDLER (ROUTER) ---

        function handleMessage(topic, payloadRaw) {
            const data = JSON.parse(payloadRaw);
            log(`RX: ${data.type}`);

            // If I am Customer receiving a Request
            if (myRole === 'user' && data.type === 'PAY_REQUEST') {
                // 1. Vibrate Phone (if supported)
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                
                // 2. Show Modal
                document.getElementById('modal-amount').innerText = "$" + data.amount;
                document.getElementById('modal-store').innerText = data.storeName;
                document.getElementById('pay-modal').style.display = "flex";
            }

            // If I am Merchant receiving a Success
            if (myRole === 'merchant' && data.type === 'PAY_SUCCESS') {
                document.getElementById('charge-btn').innerText = "‚úÖ PAID";
                document.getElementById('charge-btn').style.background = "#00b894";
                alert(`SUCCESS!\nUser: ${data.user}\nStatus: ${data.status}`);
                
                // Reset after 3 seconds
                setTimeout(() => {
                    document.getElementById('charge-btn').innerText = "‚ö° Charge User";
                    document.getElementById('charge-btn').style.background = "#000";
                    document.getElementById('charge-btn').disabled = false;
                }, 3000);
            }
        }

        function closeModal() {
            document.getElementById('pay-modal').style.display = "none";
        }

    </script>
</body>
</html>
