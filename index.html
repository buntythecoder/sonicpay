<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HandPay: Palm Biometric POS</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root { --primary: #00ff88; --bg: #111; --panel: #222; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* UI Elements */
        h1 { margin: 10px 0; font-size: 1.5rem; letter-spacing: 2px; color: var(--primary); }
        .card { background: var(--panel); width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .hidden { display: none; }
        
        /* Camera View */
        .cam-wrapper { position: relative; width: 100%; height: 350px; background: #000; border-radius: 10px; overflow: hidden; border: 2px solid #333; }
        video { position: absolute; left: 0; top: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Overlays */
        #scan-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 250px; border: 4px dashed rgba(255,255,255,0.3); border-radius: 20px;
            pointer-events: none;
        }
        .scanning #scan-guide { border-color: var(--primary); animation: pulse 1s infinite; }
        
        /* Controls */
        button { background: var(--primary); color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 1rem; }
        button.secondary { background: #444; color: #fff; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 5px; text-align: center; }
        
        /* Feedback */
        #status-text { margin-top: 10px; font-weight: bold; min-height: 20px; }
        .success { color: var(--primary); }
        .error { color: #ff4444; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="view-home" class="card">
        <h1>âœ‹ HandPay</h1>
        <p>Zero-Hardware Palm POS</p>
        <button onclick="startApp('register')">New User Enrollment</button>
        <button onclick="startApp('pay')" class="secondary">Merchant Terminal</button>
        <p style="font-size:0.8rem; color:#666; margin-top:20px;">Powered by MediaPipe & WebGL</p>
    </div>

    <div id="view-cam" class="card hidden">
        <h2 id="mode-title">Scan Palm</h2>
        <div id="input-area" class="hidden">
            <input type="text" id="user-name" placeholder="Enter Your Name">
        </div>
        
        <div class="cam-wrapper">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
            <div id="scan-guide"></div>
        </div>

        <div id="status-text">Loading AI Model...</div>
        <button id="action-btn" onclick="capture()" disabled>Analyzing Hand...</button>
        <button onclick="location.reload()" class="secondary" style="margin-top:5px; padding:10px;">Exit</button>
    </div>

    <div id="view-receipt" class="card hidden" style="border: 2px solid var(--primary);">
        <h1 style="font-size:3rem">âœ…</h1>
        <h2>Payment Success</h2>
        <p>User: <b id="r-user">...</b></p>
        <p>HandID: <span id="r-id" style="font-family:monospace; font-size:0.8rem">...</span></p>
        <button onclick="location.reload()">Done</button>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        let currentMode = ''; // 'register' or 'pay'
        let db = JSON.parse(localStorage.getItem('handpay_users')) || [];
        let detectedHand = null;
        let isStable = false;
        let stabilityCounter = 0;

        // --- 1. SETUP MEDIAPIPE HANDS ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(onResults);

        // --- 2. CAMERA LOOP ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        // --- 3. CORE LOGIC: HAND ANALYSIS ---
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                detectedHand = landmarks;
                
                // Draw Skeleton (Iron Man Style)
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00ff88', lineWidth: 3});
                drawLandmarks(canvasCtx, landmarks, {color: '#ffffff', lineWidth: 1, radius: 4});

                // Liveness/Stability Check
                checkStability(landmarks);
            } else {
                detectedHand = null;
                resetStability("Show Hand");
            }
            canvasCtx.restore();
        }

        // Simple stability check: User must hold hand still for ~30 frames
        function checkStability(landmarks) {
            // In a real app, we'd check coordinate variance over time.
            // For demo, we just count consecutive successful frames.
            stabilityCounter++;
            
            const btn = document.getElementById('action-btn');
            const guide = document.getElementById('scan-guide');
            const status = document.getElementById('status-text');

            if (stabilityCounter > 20) {
                isStable = true;
                guide.style.borderColor = "#00ff88"; // Green
                status.innerHTML = "<span class='success'>Hand Detected. Ready.</span>";
                btn.disabled = false;
                btn.innerText = currentMode === 'register' ? "ðŸ“¸ Enroll Hand" : "ðŸ’³ Verify & Pay";
                btn.style.background = "#00ff88";
            } else {
                guide.style.borderColor = "yellow";
                status.innerText = "Hold Still...";
            }
        }

        function resetStability(msg) {
            stabilityCounter = 0;
            isStable = false;
            document.getElementById('status-text').innerText = msg;
            document.getElementById('scan-guide').style.borderColor = "rgba(255,255,255,0.3)";
            const btn = document.getElementById('action-btn');
            btn.disabled = true;
            btn.innerText = "Scanning...";
            btn.style.background = "#555";
        }

        // --- 4. BIOMETRIC HASHING (SIMPLIFIED) ---
        // Converts 21 3D points into a unique "Signature String" based on finger ratios
        function generateHandHash(landmarks) {
            // Calculate distance between Wrist (0) and Middle Finger Tip (12)
            const palmSize = Math.hypot(landmarks[0].x - landmarks[12].x, landmarks[0].y - landmarks[12].y);
            
            // Normalize all finger lengths against palm size (Scale Invariant)
            const thumb = Math.hypot(landmarks[0].x - landmarks[4].x, landmarks[0].y - landmarks[4].y) / palmSize;
            const index = Math.hypot(landmarks[0].x - landmarks[8].x, landmarks[0].y - landmarks[8].y) / palmSize;
            const pinky = Math.hypot(landmarks[0].x - landmarks[20].x, landmarks[0].y - landmarks[20].y) / palmSize;

            // Create a simple string signature (e.g., "0.65-0.98-0.72")
            return `${thumb.toFixed(2)}-${index.toFixed(2)}-${pinky.toFixed(2)}`;
        }

        // --- 5. APP FLOW HANDLERS ---
        function startApp(mode) {
            currentMode = mode;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-cam').classList.remove('hidden');
            
            if (mode === 'register') {
                document.getElementById('mode-title').innerText = "Enroll New Palm";
                document.getElementById('input-area').classList.remove('hidden');
            } else {
                document.getElementById('mode-title').innerText = "Merchant Terminal";
            }
            
            camera.start();
        }

        function capture() {
            if (!detectedHand || !isStable) return;

            const handHash = generateHandHash(detectedHand);

            if (currentMode === 'register') {
                const name = document.getElementById('user-name').value;
                if (!name) return alert("Enter name first!");

                db.push({ name: name, hash: handHash });
                localStorage.setItem('handpay_users', JSON.stringify(db));
                alert("Palm Registered! Now switch to Merchant Mode.");
                location.reload();

            } else {
                // VERIFY (Matching Logic)
                // In real life, use Euclidian Distance. Here, we do exact string match for demo simplicity.
                // We allow a tiny margin of error by checking substring or simple proximity? 
                // For this strict demo, we'll try to find an exact match or close enough.
                
                const match = db.find(user => user.hash === handHash);
                
                // MOCK MATCH for Demo UX (Since exact float matching is hard in 1 try):
                // If the hash is "close enough" (first 3 chars match), we accept.
                const looseMatch = db.find(user => Math.abs(parseFloat(user.hash) - parseFloat(handHash)) < 0.1);

                if (looseMatch || match) {
                    const user = match || looseMatch;
                    document.getElementById('view-cam').classList.add('hidden');
                    document.getElementById('view-receipt').classList.remove('hidden');
                    document.getElementById('r-user').innerText = user.name;
                    document.getElementById('r-id').innerText = user.hash;
                } else {
                    alert("Access Denied: Palm not recognized.\nTry holding hand at same distance as enrollment.");
                }
            }
        }
    </script>
</body>
</html>
