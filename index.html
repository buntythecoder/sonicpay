<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SonicPay Ultrasonic</title>
    <style>
        :root { --bg: #000; --text: #eee; --c0: #00E676; --c1: #00B0FF; --start: #FFD600; --stop: #FF1744; }
        body { background: var(--bg); color: var(--text); font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        .container { flex: 1; display: flex; flex-direction: column; padding: 15px; }
        .hidden { display: none !important; }

        .btn {
            width: 100%; padding: 20px; margin-bottom: 10px;
            background: #222; border: 1px solid #555; color: #fff;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 8px;
        }
        .btn-active { background: var(--c0); color: #000; border-color: var(--c0); }

        input[type="number"] {
            background: transparent; border: none; border-bottom: 2px solid var(--c0);
            color: #fff; font-size: 3rem; width: 100%; text-align: center; outline: none;
            font-family: monospace; font-weight: bold; margin: 20px 0;
        }

        .bit-stream {
            display: flex; flex-wrap: wrap; gap: 4px; padding: 10px;
            background: #111; border: 1px solid #333; min-height: 60px;
            margin-bottom: 10px; align-items: center; justify-content: center;
        }
        .bit {
            width: 15px; height: 30px; background: #222; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #555; font-size: 0.8rem;
        }
        .b-sent { background: var(--c0); color: #000; }
        .b-rec { background: var(--c1); color: #fff; animation: pop 0.2s; }
        @keyframes pop { 0% { transform: scale(1.5); } 100% { transform: scale(1); } }

        .monitor-panel {
            background: #000; border: 1px solid #333; padding: 10px;
            margin-bottom: 10px; height: 180px; position: relative;
            display: flex; align-items: flex-end; justify-content: center; gap: 8px;
        }
        .bar-col { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; position: relative; }
        .bar { width: 100%; transition: height 0.05s; }
        .lbl { text-align: center; font-size: 0.6rem; margin-top: 5px; color: #888; }

        .gate-line {
            position: absolute; left: 0; width: 100%; height: 2px;
            background: var(--stop); z-index: 10; pointer-events: none; transition: bottom 0.1s;
        }

        .slider-box { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        input[type=range] { width: 100%; cursor: pointer; }

        .terminal {
            flex: 1; background: #080808; border: 1px solid #333;
            padding: 5px; overflow-y: auto; font-size: 0.7rem; color: #aaa;
            display: flex; flex-direction: column-reverse;
        }
        .log-row { border-bottom: 1px solid #222; padding: 2px 0; }
        .log-head { color: var(--start); border-top: 1px dashed #444; margin-top: 5px; }
        .log-succ { color: var(--c0); font-weight: bold; }
        .log-err { color: var(--stop); }

        .success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,20,0,0.98); z-index: 300;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="setup" class="container" style="justify-content:center;">
        <h1 style="text-align:center; color:var(--c0)">SonicPay</h1>
        <p style="text-align:center; color:#aaa;">ULTRASONIC (17k-20k)</p>
        <button class="btn" onclick="init('tx')">SENDER</button>
        <button class="btn" onclick="init('rx')">RECEIVER</button>
    </div>

    <div id="tx-view" class="container hidden">
        <h2>Merchant</h2>
        <div style="font-size:0.8rem; color:#aaa;">ENTER AMOUNT</div>
        <div style="display:flex; align-items:center;">
            <span style="font-size:3rem; color:#555;">$</span>
            <input type="number" id="tx-amt" value="50" min="1" max="255">
        </div>
        <div id="tx-bits" class="bit-stream">Waiting...</div>
        <button id="btn-send" class="btn btn-active" onclick="transmit()">SEND DATA (SILENT)</button>
    </div>

    <div id="rx-view" class="container hidden">
        <h2>Receiver Log</h2>
        <div class="monitor-panel">
            <div id="gate-visual" class="gate-line" style="bottom: 10%"></div>
            
            <div class="bar-col">
                <div id="b-start" class="bar" style="height:0%; background:var(--start)"></div>
                <div class="lbl">17.5k<br>START</div>
            </div>
            <div class="bar-col">
                <div id="b-0" class="bar" style="height:0%; background:var(--c0)"></div>
                <div class="lbl">18.2k<br>BIT 0</div>
            </div>
            <div class="bar-col">
                <div id="b-1" class="bar" style="height:0%; background:var(--c1)"></div>
                <div class="lbl">18.9k<br>BIT 1</div>
            </div>
            <div class="bar-col">
                <div id="b-stop" class="bar" style="height:0%; background:var(--stop)"></div>
                <div class="lbl">19.6k<br>STOP</div>
            </div>
        </div>

        <div class="slider-box">
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                <span>ULTRASONIC SENSITIVITY</span>
                <span id="gate-val" style="color:var(--stop)">20</span>
            </div>
            <input type="range" min="5" max="100" value="20" oninput="updateGate(this.value)">
        </div>

        <div id="rx-bit-vis" class="bit-stream"></div>
        <div id="rx-log" class="terminal"></div>
    </div>

    <div id="success" class="success-overlay hidden" onclick="location.reload()">
        <div style="font-size:6rem; color:var(--c0)">âœ“</div>
        <h1 id="final-amt" style="font-size:3rem; margin:10px 0;">PAID</h1>
        <div style="color:#aaa;">Ultrasonic Transfer Complete</div>
    </div>

<script>
    // --- ULTRASONIC CONFIG ---
    // Target Range: 17.5kHz to 19.6kHz
    const F_START = 17500; 
    const F0      = 18200; 
    const F1      = 18900; 
    const F_STOP  = 19600; 

    // Timing (0.3s per bit for reliability in high freq)
    const BIT_RATE = 0.30; 
    
    // Default Gate is LOW because high freq is quieter
    let GATE = 20;

    let ctx, analyser;
    let isRx = false;

    // CRC8
    function calcChecksum(bits) {
        let xor = 0;
        for(let i=0; i<bits.length; i+=4) xor ^= parseInt(bits.substr(i, 4), 2);
        return xor.toString(2).padStart(4, '0');
    }

    function init(role) {
        document.getElementById('setup').classList.add('hidden');
        if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        if(role === 'tx') document.getElementById('tx-view').classList.remove('hidden');
        else {
            document.getElementById('rx-view').classList.remove('hidden');
            startRx();
        }
    }

    function updateGate(v) {
        GATE = parseInt(v);
        document.getElementById('gate-val').innerText = GATE;
        document.getElementById('gate-visual').style.bottom = (GATE/2.55) * 4 + "%"; // Scale for visual
    }

    function log(msg, type='') {
        const d = document.getElementById('rx-log');
        const r = document.createElement('div');
        r.className = 'log-row ' + type;
        const time = new Date().toLocaleTimeString().split(' ')[0];
        r.innerText = `[${time}] ${msg}`;
        d.prepend(r);
    }

    // --- TRANSMITTER ---
    function transmit() {
        if(ctx.state === 'suspended') ctx.resume();
        const amt = document.getElementById('tx-amt').value;
        const btn = document.getElementById('btn-send');
        const disp = document.getElementById('tx-bits');

        // Payload
        const bAmt = parseInt(amt).toString(2).padStart(8, '0');
        const bChk = calcChecksum(bAmt);
        const payload = bAmt + bChk;

        disp.innerHTML = "";
        for(let i=0; i<payload.length; i++) disp.innerHTML += `<div id="tx-b-${i}" class="bit">${payload[i]}</div>`;
        btn.disabled = true;
        btn.innerText = "TRANSMITTING...";

        let t = ctx.currentTime + 0.5;

        // 1. START (1.0s)
        playTone(F_START, t, 1.0);
        t += 1.0;

        // 2. DATA
        for(let i=0; i<payload.length; i++) {
            const freq = (payload[i] === '1') ? F1 : F0;
            playTone(freq, t, BIT_RATE);
            
            setTimeout(() => {
                document.getElementById(`tx-b-${i}`).className = "bit b-sent";
            }, (t - ctx.currentTime) * 1000);

            t += BIT_RATE;
        }

        // 3. STOP (1.0s)
        playTone(F_STOP, t, 1.0);
        
        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = "SEND DATA (SILENT)";
        }, (t - ctx.currentTime) * 1000 + 500);
    }

    function playTone(f, t, d) {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; // Sine is cleaner for ultrasonic (prevents audible clicking)
        o.frequency.value = f;
        o.connect(g); g.connect(ctx.destination);
        
        // Soft envelope to avoid "Pop" at start/end
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(1, t + 0.1);
        g.gain.setValueAtTime(1, t + d - 0.1);
        g.gain.linearRampToValueAtTime(0, t + d);
        o.start(t); o.stop(t + d + 0.05);
    }

    // --- RECEIVER ---
    async function startRx() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false }});
            const src = ctx.createMediaStreamSource(stream);
            analyser = ctx.createAnalyser();
            analyser.fftSize = 2048;
            
            // CRITICAL: High Pass Filter > 15kHz
            // This KILLS all construction noise.
            const f = ctx.createBiquadFilter();
            f.type = 'highpass';
            f.frequency.value = 15000;
            src.connect(f); f.connect(analyser);
            
            isRx = true;
            loop();
            log("Ultrasonic Listener Ready. HPF > 15kHz", "log-info");
        } catch(e) { alert("Mic Error"); }
    }

    let rxState = "IDLE";
    let buffer = "";
    let lastTime = 0;
    let startFrames = 0;
    let stopFrames = 0;

    function loop() {
        if(!isRx) return;
        requestAnimationFrame(loop);

        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);
        const hz = ctx.sampleRate / analyser.fftSize;
        
        // Wide-band detection (sum 3 bins) for ultrasonic drift
        const getV = (f) => { 
            const i = Math.floor(f/hz); 
            return (data[i-1] + data[i] + data[i+1]) / 3; 
        };

        const vStart = getV(F_START);
        const v0 = getV(F0);
        const v1 = getV(F1);
        const vStop = getV(F_STOP);

        // UI
        document.getElementById('b-start').style.height = (vStart/2.55)*100 + "%";
        document.getElementById('b-0').style.height = (v0/2.55)*100 + "%";
        document.getElementById('b-1').style.height = (v1/2.55)*100 + "%";
        document.getElementById('b-stop').style.height = (vStop/2.55)*100 + "%";

        // 1. CHECK START
        if (vStart > GATE && vStart > v0 && vStart > v1) {
            startFrames++;
            if (startFrames > 10) handleStart(); 
            return;
        } else { startFrames = 0; }

        // 2. CHECK STOP
        if (vStop > GATE && vStop > v0 && vStop > v1) {
            stopFrames++;
            if (stopFrames > 10) handleStop(); 
            return;
        } else { stopFrames = 0; }

        // 3. RECORD DATA
        if (rxState === "RECEIVING") {
            const now = Date.now();
            if (now - lastTime > BIT_RATE * 1000) {
                const maxData = Math.max(v0, v1);
                
                if (maxData < GATE) return; // Silence

                let bit = (v0 > v1) ? '0' : '1';
                buffer += bit;
                lastTime = now;
                
                const d = document.createElement('div');
                d.className = bit==='1' ? "bit b-rec" : "bit b-sent";
                d.innerText = bit;
                document.getElementById('rx-bit-vis').appendChild(d);
                log(`Rec: ${bit}`);
            }
        }
    }

    function handleStart() {
        const now = Date.now();
        if (now - lastTime < 1000) return;

        rxState = "RECEIVING";
        buffer = "";
        document.getElementById('rx-bit-vis').innerHTML = "";
        lastTime = now;
        log(">>> ULTRASONIC START DETECTED", "log-head");
    }

    function handleStop() {
        const now = Date.now();
        if (now - lastTime < 1000) return; 

        if (rxState === "RECEIVING") {
            rxState = "IDLE";
            lastTime = now;
            log(">>> STOP DETECTED. Verifying...", "log-head");
            processData();
        }
    }

    function processData() {
        log(`Raw: ${buffer}`);
        if (buffer.length >= 12) {
            // Brute force align
            for(let i=0; i <= buffer.length - 12; i++) {
                const pkt = buffer.substr(i, 12);
                const bAmt = pkt.substr(0, 8);
                const bChk = pkt.substr(8, 4);
                
                const amt = parseInt(bAmt, 2);
                const rxChk = parseInt(bChk, 2);
                const calcChk = parseInt(calcChecksum(bAmt), 2);
                
                if (rxChk === calcChk) {
                    log(`VALID PACKET: $${amt}`, "log-succ");
                    success(amt);
                    return;
                }
            }
            log("Checksum Fail", "log-err");
        } else {
            log("Packet too short", "log-err");
        }
    }

    function success(a) {
        document.getElementById('success').classList.remove('hidden');
        document.getElementById('final-amt').innerText = "$" + a;
        if(navigator.vibrate) navigator.vibrate(200);
    }

</script>
</body>
</html>
