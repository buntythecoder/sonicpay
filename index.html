<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashID: Biometric Payment</title>
    <style>
        /* --- CSS STYLES (Cyberpunk/Tech Look) --- */
        :root {
            --primary: #00f2ea;
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f8fafc;
            --success: #22c55e;
            --error: #ef4444;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { color: var(--primary); letter-spacing: 2px; text-transform: uppercase; font-size: 1.5rem; }
        
        /* Containers */
        .view { display: none; width: 100%; max-width: 400px; animation: fadeIn 0.3s ease; }
        .active { display: flex; flex-direction: column; gap: 15px; }
        
        /* Cards */
        .card { background: var(--panel); padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; }
        
        /* Camera UI */
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid #333;
        }
        video, canvas { width: 100%; height: 100%; object-fit: cover; }
        .overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 180px;
            border: 3px solid var(--primary);
            border-radius: 50%; /* Oval for finger */
            box-shadow: 0 0 20px var(--primary);
            opacity: 0.7;
        }
        .scan-line {
            width: 100%; height: 2px; background: var(--primary);
            position: absolute; top: 0;
            animation: scan 2s infinite linear;
        }

        /* Buttons & Inputs */
        button {
            background: var(--primary); color: #000; border: none;
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1rem;
            cursor: pointer; width: 100%; margin-top: 10px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background: #334155; color: #fff; }
        input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569;
            background: #0f172a; color: #fff; font-size: 1rem; text-align: center;
            box-sizing: border-box;
        }

        /* Notifications */
        #status-msg { margin-top: 10px; font-size: 0.9rem; min-height: 20px; }
        .success { color: var(--success); }
        .error { color: var(--error); }

        @keyframes scan { 0% {top:0;} 50% {top:100%;} 100% {top:0;} }
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    </style>
</head>
<body>

    <h1>FlashID <span style="font-size:0.5em; color:#666">v1.0</span></h1>

    <div id="view-home" class="view active">
        <div class="card">
            <p>Select your role:</p>
            <button onclick="switchView('view-register')">üë§ Customer Registration</button>
            <button onclick="switchView('view-merchant')" class="secondary">üè™ Merchant POS</button>
            <div style="margin-top:20px; font-size:0.8em; color:#666">
                Database: <span id="db-count">0</span> users stored locally.
            </div>
            <button onclick="clearDb()" style="background:#ef4444; color:white; font-size:0.8em; padding:5px; margin-top:20px;">Reset Database</button>
        </div>
    </div>

    <div id="view-register" class="view">
        <div class="card">
            <h2>Enroll Fingerprint</h2>
            <input type="text" id="reg-name" placeholder="Enter Your Name" />
            
            <div class="camera-container">
                <video id="video-reg" autoplay playsinline></video>
                <canvas id="canvas-reg" style="display:none"></canvas>
                <div class="overlay"><div class="scan-line"></div></div>
            </div>
            
            <p style="font-size:0.8rem; color:#aaa;">Place finger inside the oval. <br>Ensure flash is ON or environment is bright.</p>
            <button onclick="captureFingerprint('register')">üì∏ Capture & Save</button>
            <button onclick="stopCamera(); switchView('view-home')" class="secondary">Back</button>
            <div id="reg-status" id="status-msg"></div>
        </div>
    </div>

    <div id="view-merchant" class="view">
        <div class="card">
            <h2>Merchant Terminal</h2>
            <input type="number" id="pay-amount" placeholder="$0.00" />
            
            <div class="camera-container">
                <video id="video-merch" autoplay playsinline></video>
                <canvas id="canvas-merch" style="display:none"></canvas>
                <div class="overlay"><div class="scan-line"></div></div>
            </div>

            <p style="font-size:0.8rem; color:#aaa;">Ask customer to scan finger to authorize.</p>
            <button onclick="captureFingerprint('verify')">üîç Scan & Charge</button>
            <button onclick="stopCamera(); switchView('view-home')" class="secondary">Back</button>
            <div id="merch-status" id="status-msg"></div>
        </div>
    </div>

    <div id="view-success" class="view">
        <div class="card" style="border: 2px solid var(--success);">
            <h2 style="color:var(--success)">Payment Approved!</h2>
            <h1 id="receipt-amount" style="color:white; font-size:3rem">$0.00</h1>
            <p>Customer: <b id="receipt-user">Unknown</b></p>
            <p style="color:#aaa; font-size:0.8rem">Transaction ID: <span id="tx-id"></span></p>
            <hr style="border-color:#333">
            <button onclick="switchView('view-home')">Done</button>
        </div>
    </div>

    <script>
        // --- 1. MEMORY STORAGE (Simulated Server) ---
        let db = JSON.parse(localStorage.getItem('flashid_users')) || [];
        updateDbCount();

        // --- 2. CAMERA HANDLING ---
        let currentStream = null;

        async function startCamera(videoElementId) {
            const video = document.getElementById(videoElementId);
            if (currentStream) stopCamera();

            try {
                // Request camera with Torch (Flash) capability if available
                const constraints = { 
                    video: { 
                        facingMode: "environment", // Back camera
                        advanced: [{ torch: true }] // Try to turn on flash
                    } 
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;

                // Try to force flash on (Chrome/Android specific)
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    track.applyConstraints({ advanced: [{ torch: true }] });
                }

            } catch (err) {
                console.error("Camera Error:", err);
                alert("Camera access denied or Flash not supported. Please allow camera permissions.");
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        // --- 3. CORE LOGIC ---
        
        function captureFingerprint(mode) {
            const videoId = mode === 'register' ? 'video-reg' : 'video-merch';
            const canvasId = mode === 'register' ? 'canvas-reg' : 'canvas-merch';
            const statusId = mode === 'register' ? 'reg-status' : 'merch-status';
            
            const video = document.getElementById(videoId);
            const canvas = document.getElementById(canvasId);
            const status = document.getElementById(statusId);
            
            if (!currentStream || video.readyState !== 4) {
                status.innerHTML = "<span class='error'>Camera not ready.</span>";
                return;
            }

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // --- IMAGE PROCESSING (Simulate Fingerprint Extraction) ---
            // In a real app, this would use OpenCV to extract minutiae points.
            // Here, we calculate average "Redness" to detect skin/finger over flash.
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let r_total = 0, g_total = 0, b_total = 0;
            
            for (let i = 0; i < frame.data.length; i += 400) { // Sample every 100th pixel for speed
                r_total += frame.data[i];
                g_total += frame.data[i+1];
                b_total += frame.data[i+2];
            }
            const pixels = frame.data.length / 400;
            const avgR = r_total / pixels;
            
            // LOGIC: A finger over a flash is usually BRIGHT and RED/ORANGE.
            // If the image is too dark, no finger is present.
            const isFingerDetected = (avgR > 60); // Simple threshold

            if (!isFingerDetected) {
                status.innerHTML = "<span class='error'>‚ö†Ô∏è No finger detected! Place finger closer.</span>";
                return;
            }

            // --- ROUTING ---
            if (mode === 'register') {
                const name = document.getElementById('reg-name').value;
                if (!name) { alert("Please enter a name."); return; }
                
                // Save to 'Server'
                const newUser = {
                    id: Date.now(),
                    name: name,
                    // We store a dummy 'hash' for the demo. In real life, this is the biometric template.
                    fingerData: "simulated_hash_" + Math.random() 
                };
                
                db.push(newUser);
                localStorage.setItem('flashid_users', JSON.stringify(db));
                updateDbCount();
                
                status.innerHTML = "<span class='success'>‚úÖ Registered successfully!</span>";
                setTimeout(() => { stopCamera(); switchView('view-home'); }, 1500);

            } else if (mode === 'verify') {
                // MATCHING LOGIC
                if (db.length === 0) {
                    status.innerHTML = "<span class='error'>No users in database. Register first.</span>";
                    return;
                }

                // SIMULATION: Since we can't match real fingerprints in basic JS without 
                // heavy libraries, we simulate a match if a valid "Finger-like" image was captured.
                // In a real app, we would compare `frame` data to stored `fingerData`.
                
                const amount = document.getElementById('pay-amount').value;
                if(!amount) { alert("Enter amount"); return; }

                status.innerHTML = "<span style='color:#fbbf24'>Identifying...</span>";
                
                setTimeout(() => {
                    // Mock Match: Just pick the last registered user for the demo flow
                    const matchedUser = db[db.length - 1]; 
                    
                    document.getElementById('receipt-amount').innerText = "$" + amount;
                    document.getElementById('receipt-user').innerText = matchedUser.name;
                    document.getElementById('tx-id').innerText = "TX-" + Math.floor(Math.random()*100000);
                    
                    stopCamera();
                    switchView('view-success');
                }, 1000);
            }
        }

        // --- 4. VIEW CONTROLLER ---
        function switchView(viewId) {
            // Hide all
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(viewId).classList.add('active');
            
            // Handle Camera logic
            if (viewId === 'view-register') startCamera('video-reg');
            else if (viewId === 'view-merchant') startCamera('video-merch');
            else stopCamera();
        }

        function updateDbCount() {
            document.getElementById('db-count').innerText = db.length;
        }

        function clearDb() {
            if(confirm("Clear all users?")) {
                localStorage.removeItem('flashid_users');
                db = [];
                updateDbCount();
            }
        }
    </script>
</body>
</html>
